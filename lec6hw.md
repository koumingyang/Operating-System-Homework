
## 第六讲

计54 寇明阳 2015011318

### 6.1	非连续内存分配的需求背景
#### 为什么要设计非连续内存分配机制？
提高分配的灵活性
提高内存的利用效率：方便共享、充分利用内存空间
#### 非连续内存分配中内存分块大小有哪些可能的选择？大小与大小是否可变?
2的整数次幂字节，如512，4096等。大块大小可变，小块固定大小
#### 为什么在大块时要设计大小可变，而在小块时要设计成固定大小？小块时的固定大小可以提供多种选择吗？
固定大小好管理，多种大小比一种大小灵活
可变大小更灵活，通常可变大小也会通过对齐来减少管理难度
通常不能。
### 6.2	段式存储管理
#### 什么是段、段基址和段内偏移？
段表示访问方式和存储数据等属性相同的一段地址空间
段地址 = 段基址 × 16 + 偏移地址
也就是：实际地址 = 段基址 × 16 + 补偿地址
段地址指的是物理地址
段基址指的是当前段寄存器的内容。
#### 段式存储管理机制的地址转换流程是什么？为什么在段式存储管理中，各段的存储位置可以不连续？这种做法有什么好处和麻烦？
段式存储管理中，地址转换是段基址（段号）加段内偏移
段反映了程序的存储逻辑结构，程序不会从一个段的基址去访问另一个段，于是不同的段可以不连续。
好处是可以不连续，方便内存管理；麻烦是地址转换稍微复杂了一些。
### 6.3	页式存储管理
#### 什么是页（page）、帧（frame）、页表（page table）、存储管理单元（MMU）、快表（TLB, Translation Lookaside Buffer）和高速缓存（cache）？
MMU即内存管理单元(Memory Manage Unit），是一个与软件密切相关的硬件部件，负责把虚拟地址翻译为物理地址。

MMU中VA到PA映射的最小单位称为页(Page)，映射的最低粒度是单个虚拟页到物理页，页大小通常是4K，即一次最少要把4K大小的VA页块整体映射到4K的PA页块（从0开始4K对齐划分页块），页内偏移不变，如VA的一页0x30004000~0x30004fff被映射到PA的一页 0x00008000~0x00008fff，当CPU执行单元访问虚拟地址0x30004008，实际访问的物理地址是0x00008008（0x30004008和0x00008008分别位于虚实两套地址空间，互不相干，不存在重叠和冲突）。以页为最小单位，就是不能把VA中某一页划分成几小块分别映射到不同PA，也不能把VA中属于不同页的碎块映射到PA某一页的不同部分，必须页对页整体映射。

页帧（Page Frame）是指物理内存中的一页内存，MMU虚实地址映射就是寻找物理页帧的过程，对这个概念了解就可以了。

MMU软件配置的核心是页表（Page Table），它描述MMU的映射规则，即虚拟内存哪(几)个页映射到物理内存哪(几)个页帧。页表由一条条代表映射规则的记录组成，每一条称为一个页表条目（Page Table Entry,即PTE），整个页表保存在片外内存，MMU通过查找页表确定一个VA应该映射到什么PA，以及是否有权限映射。

TLB (Translation Lookaside Buffers)即转换快表，又简称快表，可以理解为MMU内部专用的存放页表的cache，保存着最近使用的PTE乃至全部页表。MMU接收到虚拟地址后，首先在TLB中查找，如果找到该VA对应的PTE就直接转换，找不到再去外存页表查找，并置换进TLB。TLB属于片上SRAM，访问速度快，通过TLB缓存PTE可以节省MMU访问外存页表的时间，从而加速虚实地址转换。TLB和CPU cache的工作原理一样，只是TLB专用于为MMU缓存页表。

高速缓冲存储器（Cache）其原始意义是指存取速度比一般随机存取记忆体（RAM）来得快的一种RAM，一般而言它不像系统主记忆体那样使用DRAM技术，而使用昂贵但较快速的SRAM技术，也有快取记忆体的名称。高速缓冲存储器是存在于主存与CPU之间的一级存储器， 由静态存储芯片(SRAM)组成，容量比较小但速度比主存高得多， 接近于CPU的速度。在计算机存储系统的层次结构中，是介于中央处理器和主存储器之间的高速小容量存储器。它和主存储器一起构成一级的存储器。高速缓冲存储器和主存储器之间信息的调度和传送是由硬件自动进行的。
#### 页式存储管理机制的地址转换流程是什么？为什么在页式存储管理中，各页的存储位置可以不连续？这种做法有什么好处和麻烦？
页式存储管理中，地址转换是页号加页内偏移
CPU使用连续的逻辑地址，存储访问时，逻辑地址先分成逻辑页号和页内偏移，然后通过页表定义的对应关系，把逻辑页面转换成物理页号，最后再把物理页号加页内偏移得到物理地址；于是不同的段可以不连续。
好处是可以不连续，方便内存管理中的存储分配和回收；麻烦是地址转换比较复杂（页表项访问开销和页表存储开销），并且频繁进行（每次存储访问会变成两次或更多）。
### 6.4	页表概述
#### 每个页表项有些什么内容？有哪些标志位？它们起什么作用？
在请求分页系统中，其页表项中包含的数据项有页号，物理块号，状态位P，访问字段A，修改位M和外存地址。
其中状态位P指示该页是否调入内存，供程序访问时参考。
访问字段A用于记录本页在一段时间内被访问的次数，或最近已有多长时间未被访问，提供给置换算法选择换出页面时参考。
修改位M表示该页在调入内存后是否被修改过。
外存地址用于指出该页在外存上的地址，通常是物理块号，供调入该页时使用
#### 页表大小受哪些因素影响？
页大小、地址空间大小、进程数目
### 6.5	快表和多级页表
#### 快表（TLB）与高速缓存（cache）有什么不同？
TLB：加速虚拟地址-->物理地址的转换，如果没有TLB的话每次进行地址转换都要访问内存。TLB结构有点像cache。
cache：存放最近使用的数据和指令，对于上层来说cache是透明的。
cache中的数据存在时间局域性和空间局域性。TLB中存放的是物理地址只有时间局域性。
cache存放数据，TLB存放物理地址
#### 为什么快表中查找物理地址的速度非常快？它是如何实现的？为什么它的的容量很小？
采用联想存储器加快查表速度，在地址变换机构中，加入一个高速，小容量、具有并行查询能力的联想存储器，构成快表，存放正运行的作业的当前页号和块号。
#### 什么是多级页表？多级页表中的地址转换流程是什么？多级页表有什么好处和麻烦？
多级页表：页表和页面一样也进行分页，内存仅存放当前使用的页表，暂时不用部分存在磁盘上，待用时再进行调进。
获得逻辑地址后，用寄存器中存储的信息一层一层对页表进行查询。
好处：多级页表索引空间远大于单级页表。即，相同存储空间文件，用多级页表表示的话，页表项很少，占用的存储空间就少。
麻烦：多级页表减慢地址转换速度
### 6.6	反置页表
#### 页寄存器机制的地址转换流程是什么？
获得页寄存器的内容后，逻辑地址进行hash，然后查相应页寄存器
#### 反置页表机制的地址转换流程是什么？
获得反置页表项的内容后，逻辑地址和进程号共同进行hash，然后查相应页寄存器
#### 反置页表项有些什么内容？
PID、逻辑页号、标志位
### 6.7	段页式存储管理
#### 段页式存储管理机制的地址转换流程是什么？这种做法有什么好处和麻烦？
段页式存储管理方式即先将用户程序分成若干个段，再把每个段分成若干个页，并为每一个段赋予一个段名。右图示出了一个作业的地址空间和地址结构。
在段页式系统中，为了便于实现地址变换，须配置一个段表寄存器，其中存放段表始址和段表长TL。进行地址变换时，首先利用段号S，将它与段表长TL进行比较。若S<TL，表示未越界，于是利用段表始址
和段号来求出该段所对应的段表项在段表中的位置，从中得到该段的页表始址，并利用逻辑地址中的段内页号P来获得对应页的页表项位置，从中读出该页所在的物理块号b，再利用块号b和页内地址来构成物理地址。右图示出了段页式系统中的地址变换机构。
在段页式系统中，为了获得一条指令或数据，须三次访问内存。第一次访问是访问内存中的段表，从中取得页表始址；第二次访问是访问内存中的页表，从中取出该页所在的物理块号，并将该块号与页内地址一起形成指令或数据的物理地址；第三次访问才是真正从第二次访问所得的地址中，取出指令或数据。
显然，这使访问内存的次数增加了近两倍。为了提高执行速度，在地址变换机构中增设一个高速缓冲寄存器。每次访问它时，都须同时利用段号和页号去检索高速缓存，若找到匹配的表项，便可从中得到相应页的物理块号，用来与页内地址一起形成物理地址；若未找到匹配表项，则仍须再三次访问内存。
麻烦是速度较慢，好处是在需要多次访问位置接近的内存数据时速度快。
#### 如何实现基于段式存储管理的内存共享？如何实现基于页式存储管理的内存共享？
分页式是将线性地址空间直接分成大小相同的页进行存储，分段式则是根据用户有逻辑意义的程序模块划分地址空间。页的共享是使相关进程的逻辑空间中的页指向相同的内存块，若页中既有共享的部分又有不共享的部分则不好实现。页面保护必须设置存储保护键指明对其内容的存取权限。实现页(段)的共享是指某些作业的逻辑页号(段号)对应同一物理页号(内存中该段的起始地址)。页(段)的保护往往需要对共享的页面(段)加上某种访问权限的限制，如不能修改等；或设置地址越界检查，对于页内地址(段内地址)大于页长(段长)的存取，产生保护中断。因为页的划
